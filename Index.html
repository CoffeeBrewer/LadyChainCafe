<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CafÃ© Blockchain Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="background-overlay"></div>

    <header class="top-bar">
        <div class="logo-area">
            <div class="logo-circle">â˜•</div>
            <div class="logo-text">
                <span class="logo-main">CafÃ© Chain</span>
                <span class="logo-sub">Powered by LadyScan</span>
            </div>
        </div>
        <div class="network-pill">
            <span class="dot"></span>
            <span id="network-name">Mainnet</span>
        </div>
    </header>

    <main class="dashboard-container">
        <section class="hero">
            <div>
                <h1>Welcome to the Blockchain CafÃ©</h1>
                <p class="hero-subtitle">
                    Grab a coffee and watch your chain grow:
                    blocks, wallets, transactions and more â€“ all in real time.
                </p>
            </div>
            <div class="hero-badge">
                <span class="badge-label">Live chain health</span>
                <span id="last-updated" class="badge-value">â€“</span>
            </div>
        </section>

        <!-- Stat cards -->
        <section class="cards">
            <article class="card">
                <div class="card-header">
                    <span class="card-icon">ðŸ“¦</span>
                    <h2>Blocks</h2>
                </div>
                <p class="card-label">Total number of blocks</p>
                <p id="block-count" class="card-value">â€“</p>
            </article>

            <article class="card">
                <div class="card-header">
                    <span class="card-icon">ðŸ‘›</span>
                    <h2>Wallets</h2>
                </div>
                <p class="card-label">Unique addresses</p>
                <p id="wallet-count" class="card-value">â€“</p>
            </article>

            <article class="card">
                <div class="card-header">
                    <span class="card-icon">ðŸ’¸</span>
                    <h2>Transactions</h2>
                </div>
                <p class="card-label">Total number of transactions</p>
                <p id="transaction-count" class="card-value">â€“</p>
            </article>
        </section>

        <!-- Chart: daily growth -->
        <section class="panel">
            <div class="panel-header">
                <div>
                    <h2>Daily growth</h2>
                    <p class="panel-subtitle">
                        Transactions per day â€“ see how lively your cafÃ© chain is.
                    </p>
                </div>
            </div>
            <div class="panel-body">
                <canvas id="growthChart"></canvas>
            </div>
        </section>

        <section class="two-column">
            <!-- Latest transactions -->
            <section class="panel">
                <div class="panel-header">
                    <div>
                        <h2>Latest transactions</h2>
                        <p class="panel-subtitle">
                            The most recent movements on the chain.
                        </p>
                    </div>
                </div>
                <div class="panel-body table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Hash</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Value</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="latest-transactions-body">
                            <tr><td colspan="5" class="placeholder">Loadingâ€¦</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Richest wallets -->
            <section class="panel">
                <div class="panel-header">
                    <div>
                        <h2>Richest wallets</h2>
                        <p class="panel-subtitle">
                            The biggest accounts at the bar.
                        </p>
                    </div>
                </div>
                <div class="panel-body table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Address</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="top-accounts-body">
                            <tr><td colspan="3" class="placeholder">Loadingâ€¦</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </section>
    </main>

    <footer class="footer">
        Brewed with â˜• &amp; ðŸ’» â€“ live data from <code>ladyscan.us</code>
    </footer>

    <script>
        const API_BASE = "https://ladyscan.us/api/v2";

        // Format number with max 2 decimals, no unnecessary .00
        function formatNumber(value) {
            if (
                value === null ||
                value === undefined ||
                value === "" ||
                isNaN(value)
            ) {
                return "â€“";
            }

            const num = Number(value);
            // round to 2 decimals, then strip trailing .00, then add thousands separators
            return Number(num.toFixed(2)).toLocaleString("en-US");
        }

        // Convert 18-decimal on-chain values (wei-style) into a normal JS number
        function from18(value) {
            if (value === null || value === undefined) return 0;

            try {
                const n = BigInt(value);
                const factor = BigInt("1000000000000000000"); // 1e18
                const whole = Number(n / factor);
                const decimal = Number(n % factor) / 1e18;
                return whole + decimal;
            } catch {
                // Fallback if it's not a BigInt-compatible value
                return Number(value) / 1e18;
            }
        }

        function shortenHash(hash, length = 10) {
            if (!hash) return "â€“";
            if (hash.length <= length) return hash;
            return hash.slice(0, 6) + "â€¦" + hash.slice(-4);
        }

        function formatTimestamp(ts) {
            if (!ts) return "â€“";
            const d = new Date(ts);
            if (isNaN(d.getTime())) return ts;
            return d.toLocaleString("en-GB");
        }

        async function fetchJson(path, params = "") {
            const url = API_BASE + path + params;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("API error " + response.status + " at " + url);
            }
            return response.json();
        }

        // === STATS: USE EXACT FIELD NAMES FROM /stats ===
        async function loadStats() {
            try {
                const data = await fetchJson("/stats");
                console.log("Stats response:", data);

                const blockCount = data.total_blocks;
                const addressCount = data.total_addresses;
                const txCount = data.total_transactions;

                document.getElementById("block-count").innerText = formatNumber(blockCount);
                document.getElementById("wallet-count").innerText = formatNumber(addressCount);
                document.getElementById("transaction-count").innerText = formatNumber(txCount);

                document.getElementById("last-updated").innerText =
                    "Updated: " + new Date().toLocaleTimeString("en-GB");
            } catch (err) {
                console.error(err);
            }
        }

        // === CHARTS: USE daily_transactions[].count FROM /stats/charts ===
        async function loadCharts() {
            try {
                const data = await fetchJson("/stats/charts");
                console.log("Charts response:", data);

                const daily = data.daily_transactions || [];

                // Sort by date ascending (old â†’ new)
                daily.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = daily.map((item) => {
                    const d = new Date(item.date);
                    return d.toLocaleDateString("en-GB", {
                        day: "2-digit",
                        month: "short"
                    });
                });

                const values = daily.map((item) => Number(item.count) || 0);

                const ctx = document.getElementById("growthChart").getContext("2d");
                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels,
                        datasets: [
                            {
                                label: "Transactions per day",
                                data: values,
                                borderWidth: 2,
                                tension: 0.25,
                                pointRadius: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    font: { family: "'Inter', Arial, sans-serif" }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    font: { family: "'Inter', Arial, sans-serif" }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { family: "'Inter', Arial, sans-serif" },
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error(err);
            }
        }

        // === LATEST TRANSACTIONS: DIVIDE value/amount BY 1e18 AND FORMAT ===
        async function loadLatestTransactions() {
            try {
                const data = await fetchJson("/main-page/transactions");
                console.log("Latest tx response:", data);

                const tbody = document.getElementById("latest-transactions-body");
                tbody.innerHTML = "";

                const items = data.items || data.transactions || data || [];
                if (!items.length) {
                    tbody.innerHTML =
                        '<tr><td colspan="5" class="placeholder">No transactions found</td></tr>';
                    return;
                }

                items.slice(0, 10).forEach((tx) => {
                    const tr = document.createElement("tr");

                    const hash = tx.hash || tx.tx_hash || tx.id;
                    const from = tx.from || tx.sender || tx.from_address;
                    const to = tx.to || tx.receiver || tx.to_address;

                    const rawValue = tx.value || tx.amount || tx.value_formatted || 0;
                    const value = from18(rawValue);

                    const timestamp = tx.timestamp || tx.time || tx.block_time;

                    tr.innerHTML = `
                        <td title="${hash || ""}">${shortenHash(hash)}</td>
                        <td title="${from || ""}">${shortenHash(from || "")}</td>
                        <td title="${to || ""}">${shortenHash(to || "")}</td>
                        <td>${formatNumber(value)}</td>
                        <td>${formatTimestamp(timestamp)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                const tbody = document.getElementById("latest-transactions-body");
                tbody.innerHTML =
                    '<tr><td colspan="5" class="placeholder">Error while loading transactions</td></tr>';
            }
        }

        // === TOP ACCOUNTS: DIVIDE balance BY 1e18 AND FORMAT ===
        async function loadTopAccounts() {
            try {
                const data = await fetchJson("/stats/top-accounts");
                console.log("Top accounts response:", data);

                const tbody = document.getElementById("top-accounts-body");
                tbody.innerHTML = "";

                const items = data.items || data.accounts || data || [];
                if (!items.length) {
                    tbody.innerHTML =
                        '<tr><td colspan="3" class="placeholder">No data found</td></tr>';
                    return;
                }

                items.slice(0, 10).forEach((acc, index) => {
                    const address = acc.address || acc.account || acc.wallet;

                    const rawBalance = acc.balance || acc.value || acc.amount || 0;
                    const balance = from18(rawBalance);

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td title="${address || ""}">${shortenHash(address || "", 14)}</td>
                        <td>${formatNumber(balance)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                const tbody = document.getElementById("top-accounts-body");
                tbody.innerHTML =
                    '<tr><td colspan="3" class="placeholder">Error while loading richest wallets</td></tr>';
            }
        }

        async function initDashboard() {
            await Promise.all([
                loadStats(),
                loadCharts(),
                loadLatestTransactions(),
                loadTopAccounts()
            ]);
        }

        document.addEventListener("DOMContentLoaded", initDashboard);
    </script>
</body>
</html>
